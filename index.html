<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Keto Journey Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .bmi-underweight { background: linear-gradient(135deg, #3B82F6, #1D4ED8); }
        .bmi-normal { background: linear-gradient(135deg, #10B981, #047857); }
        .bmi-overweight { background: linear-gradient(135deg, #F59E0B, #D97706); }
        .bmi-obese { background: linear-gradient(135deg, #EF4444, #DC2626); }
        
        /* Mobile optimizations */
        @media (max-width: 768px) {
            .mobile-stack { flex-direction: column; }
            .mobile-text-lg { font-size: 1.125rem; }
            .mobile-p-3 { padding: 0.75rem; }
            .mobile-chart-container { height: 300px; }
        }
        
        /* Custom scrollbar for mobile */
        .mobile-scroll {
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
        }
        
        /* Chart container responsive */
        .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
        }
        
        @media (max-width: 768px) {
            .chart-container {
                height: 300px;
            }
        }
        
        @media (max-width: 480px) {
            .chart-container {
                height: 250px;
            }
        }
        
        /* Height input with button */
        .height-input-container {
            display: flex;
            gap: 8px;
            align-items: flex-end;
        }
        
        .height-input {
            flex: 1;
        }
        
        .height-button {
            white-space: nowrap;
        }
        
        /* Goal section */
        .goal-section {
            border-left: 4px solid #8B5CF6;
        }

        /* Language switcher */
        .lang-switcher {
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(10px);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-emerald-50 to-teal-100 min-h-screen p-2 sm:p-4">
    <div id="app" class="max-w-6xl mx-auto"></div>

    <script>
        // Translation dictionary
        const translations = {
            en: {
                // Header
                title: "Keto Journey Tracker",
                import: "Import",
                export: "Export",
                
                // Profile
                profile: "Your Profile",
                height: "Height",
                heightPlaceholder: "e.g., 175",
                setHeight: "Set Height",
                change: "Change",
                heightRequired: "Required for BMI calculation. Enter your complete height and press 'Set Height' or press Enter.",
                currentHeight: "Current Height",
                
                // Goal
                weightGoal: "Weight Goal",
                goalWeight: "Goal Weight",
                targetDate: "Target Date",
                setGoal: "Set Goal",
                currentGoal: "Current Goal",
                goalBMI: "Goal BMI",
                goalDescription: "Set a goal weight and target date to see your prognosis and track progress visually.",
                
                // Stats
                currentWeight: "Current Weight",
                totalLoss: "Total Loss",
                weeks: "Weeks",
                waistHeight: "Waist/Height",
                waistHip: "Waist/Hip",
                healthy: "Healthy",
                male: "M",
                female: "F",
                
                // Charts
                progressCharts: "Progress Charts (6-Month View)",
                hideCharts: "Hide Charts",
                showCharts: "Show Charts",
                weight: "Weight",
                measurements: "Measurements",
                
                // Prognosis
                prognosisAnalysis: "Prognosis Analysis",
                daysRemaining: "Days Remaining",
                weightToLose: "Weight to Lose",
                weeklyLossNeeded: "Weekly Loss Needed",
                status: "Status",
                achievable: "üéØ Achievable",
                challenging: "‚ö†Ô∏è Challenging",
                
                // Form
                addMeasurement: "Add Measurement",
                hideForm: "Hide Form",
                weekMeasurement: "Week {{week}} Measurements",
                date: "Date",
                weightKg: "Weight (kg) *",
                chest: "Chest (cm)",
                waist: "Waist (cm)",
                hips: "Hips (cm)",
                arms: "Arms (cm)",
                thighs: "Thighs (cm)",
                notes: "Notes",
                notesPlaceholder: "How are you feeling? Any challenges or wins this week?",
                saveMeasurement: "Save Measurement",
                cancel: "Cancel",
                setHeightFirst: "(Set height first)",
                
                // History
                progressHistory: "Progress History",
                clearAll: "Clear All",
                noMeasurements: "No measurements yet. Add your first one to start tracking!",
                dontForgetHeight: "Don't forget to set your height above first!",
                
                // Instructions
                googleSheets: "How to sync with Google Sheets:",
                exportStep: "Click 'Export' to download your data",
                openSheets: "Open Google Sheets and create a new spreadsheet",
                importStep: "Go to File ‚Üí Import ‚Üí Upload ‚Üí select your CSV file",
                createCharts: "Your data will be imported and you can create charts/graphs there!",
                
                // BMI Categories
                underweight: "Underweight",
                normal: "Normal",
                overweight: "Overweight",
                obese: "Obese",
                
                // Alerts
                enterValidHeight: "Please enter a valid height between 100cm and 250cm",
                enterDateWeight: "Please enter at least date and weight",
                setHeightFirstAlert: "Please set your height first in the settings section",
                enterValidNumber: "Please enter a valid number for {{field}}",
                enterValidGoalWeight: "Please enter a valid goal weight",
                selectGoalDate: "Please select a goal date",
                selectFutureDate: "Please select a future date for your goal",
                deleteConfirm: "Are you sure you want to delete this measurement?",
                deleteAllConfirm: "Are you sure you want to delete ALL measurements? This cannot be undone."
            },
            bg: {
                // Header
                title: "–ö–µ—Ç–æ –ü—ä—Ç–µ—à–µ—Å—Ç–≤–∏–µ",
                import: "–ò–º–ø–æ—Ä—Ç",
                export: "–ï–∫—Å–ø–æ—Ä—Ç",
                
                // Profile
                profile: "–í–∞—à–∏—è—Ç –ü—Ä–æ—Ñ–∏–ª",
                height: "–í–∏—Å–æ—á–∏–Ω–∞",
                heightPlaceholder: "–Ω–∞–ø—Ä., 175",
                setHeight: "–ó–∞–¥–∞–π –í–∏—Å–æ—á–∏–Ω–∞",
                change: "–ü—Ä–æ–º–µ–Ω–∏",
                heightRequired: "–ó–∞–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–æ –∑–∞ –∏–∑—á–∏—Å–ª—è–≤–∞–Ω–µ –Ω–∞ BMI. –í—ä–≤–µ–¥–µ—Ç–µ —Ü—è–ª–∞—Ç–∞ —Å–∏ –≤–∏—Å–æ—á–∏–Ω–∞ –∏ –Ω–∞—Ç–∏—Å–Ω–µ—Ç–µ '–ó–∞–¥–∞–π –í–∏—Å–æ—á–∏–Ω–∞' –∏–ª–∏ –Ω–∞—Ç–∏—Å–Ω–µ—Ç–µ Enter.",
                currentHeight: "–¢–µ–∫—É—â–∞ –í–∏—Å–æ—á–∏–Ω–∞",
                
                // Goal
                weightGoal: "–¶–µ–ª–µ–≤–æ –¢–µ–≥–ª–æ",
                goalWeight: "–¶–µ–ª–µ–≤–æ –¢–µ–≥–ª–æ",
                targetDate: "–¶–µ–ª–µ–≤–∞ –î–∞—Ç–∞",
                setGoal: "–ó–∞–¥–∞–π –¶–µ–ª",
                currentGoal: "–¢–µ–∫—É—â–∞ –¶–µ–ª",
                goalBMI: "–¶–µ–ª–µ–≤–æ BMI",
                goalDescription: "–ó–∞–¥–∞–π—Ç–µ —Ü–µ–ª–µ–≤–æ —Ç–µ–≥–ª–æ –∏ –¥–∞—Ç–∞, –∑–∞ –¥–∞ –≤–∏–¥–∏—Ç–µ –ø—Ä–æ–≥–Ω–æ–∑–∞—Ç–∞ –∏ –¥–∞ –ø—Ä–æ—Å–ª–µ–¥—è–≤–∞—Ç–µ –ø—Ä–æ–≥—Ä–µ—Å–∞ –≤–∏–∑—É–∞–ª–Ω–æ.",
                
                // Stats
                currentWeight: "–¢–µ–∫—É—â–æ –¢–µ–≥–ª–æ",
                totalLoss: "–û–±—â–∞ –ó–∞–≥—É–±–∞",
                weeks: "–°–µ–¥–º–∏—Ü–∏",
                waistHeight: "–¢–∞–ª–∏—è/–í–∏—Å–æ—á–∏–Ω–∞",
                waistHip: "–¢–∞–ª–∏—è/–•–∞–Ω—à",
                healthy: "–ó–¥—Ä–∞–≤–æ—Å–ª–æ–≤–Ω–æ",
                male: "–ú",
                female: "–ñ",
                
                // Charts
                progressCharts: "–ì—Ä–∞—Ñ–∏–∫–∏ –Ω–∞ –ü—Ä–æ–≥—Ä–µ—Å–∞ (6-–ú–µ—Å–µ—á–µ–Ω –ò–∑–≥–ª–µ–¥)",
                hideCharts: "–°–∫—Ä–∏–π –ì—Ä–∞—Ñ–∏–∫–∏",
                showCharts: "–ü–æ–∫–∞–∂–∏ –ì—Ä–∞—Ñ–∏–∫–∏",
                weight: "–¢–µ–≥–ª–æ",
                measurements: "–ò–∑–º–µ—Ä–≤–∞–Ω–∏—è",
                
                // Prognosis
                prognosisAnalysis: "–ê–Ω–∞–ª–∏–∑ –Ω–∞ –ü—Ä–æ–≥–Ω–æ–∑–∞—Ç–∞",
                daysRemaining: "–û—Å—Ç–∞–≤–∞—â–∏ –î–Ω–∏",
                weightToLose: "–¢–µ–≥–ª–æ –∑–∞ –ì—É–±–µ–Ω–µ",
                weeklyLossNeeded: "–ù–µ–æ–±—Ö–æ–¥–∏–º–∞ –°–µ–¥–º–∏—á–Ω–∞ –ó–∞–≥—É–±–∞",
                status: "–°—Ç–∞—Ç—É—Å",
                achievable: "üéØ –ü–æ—Å—Ç–∏–∂–∏–º–æ",
                challenging: "‚ö†Ô∏è –ü—Ä–µ–¥–∏–∑–≤–∏–∫–∞—Ç–µ–ª–Ω–æ",
                
                // Form
                addMeasurement: "–î–æ–±–∞–≤–∏ –ò–∑–º–µ—Ä–≤–∞–Ω–µ",
                hideForm: "–°–∫—Ä–∏–π –§–æ—Ä–º—É–ª—è—Ä",
                weekMeasurement: "–°–µ–¥–º–∏—Ü–∞ {{week}} –ò–∑–º–µ—Ä–≤–∞–Ω–∏—è",
                date: "–î–∞—Ç–∞",
                weightKg: "–¢–µ–≥–ª–æ (kg) *",
                chest: "–ì—Ä—ä–¥ (cm)",
                waist: "–¢–∞–ª–∏—è (cm)",
                hips: "–•–∞–Ω—à (cm)",
                arms: "–†—ä—Ü–µ (cm)",
                thighs: "–ë–µ–¥—Ä–∞ (cm)",
                notes: "–ë–µ–ª–µ–∂–∫–∏",
                notesPlaceholder: "–ö–∞–∫ —Å–µ —á—É–≤—Å—Ç–≤–∞—Ç–µ? –ù—è–∫–∞–∫–≤–∏ –ø—Ä–µ–¥–∏–∑–≤–∏–∫–∞—Ç–µ–ª—Å—Ç–≤–∞ –∏–ª–∏ –ø–æ–±–µ–¥–∏ —Ç–∞–∑–∏ —Å–µ–¥–º–∏—Ü–∞?",
                saveMeasurement: "–ó–∞–ø–∞–∑–∏ –ò–∑–º–µ—Ä–≤–∞–Ω–µ—Ç–æ",
                cancel: "–û—Ç–∫–∞–∑",
                setHeightFirst: "(–ü—ä—Ä–≤–æ –∑–∞–¥–∞–π –≤–∏—Å–æ—á–∏–Ω–∞)",
                
                // History
                progressHistory: "–ò—Å—Ç–æ—Ä–∏—è –Ω–∞ –ü—Ä–æ–≥—Ä–µ—Å–∞",
                clearAll: "–ò–∑—Ç—Ä–∏–π –í—Å–∏—á–∫–∏",
                noMeasurements: "–í—Å–µ –æ—â–µ –Ω—è–º–∞ –∏–∑–º–µ—Ä–≤–∞–Ω–∏—è. –î–æ–±–∞–≤–µ—Ç–µ –ø—ä—Ä–≤–æ—Ç–æ, –∑–∞ –¥–∞ –∑–∞–ø–æ—á–Ω–µ—Ç–µ –¥–∞ –ø—Ä–æ—Å–ª–µ–¥—è–≤–∞—Ç–µ!",
                dontForgetHeight: "–ù–µ –∑–∞–±—Ä–∞–≤—è–π—Ç–µ –ø—ä—Ä–≤–æ –¥–∞ –∑–∞–¥–∞–¥–µ—Ç–µ –≤–∏—Å–æ—á–∏–Ω–∞—Ç–∞ —Å–∏ –ø–æ-–≥–æ—Ä–µ!",
                
                // Instructions
                googleSheets: "–ö–∞–∫ –¥–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–∞—Ç–µ —Å Google Sheets:",
                exportStep: "–ö–ª–∏–∫–Ω–µ—Ç–µ '–ï–∫—Å–ø–æ—Ä—Ç', –∑–∞ –¥–∞ –∏–∑—Ç–µ–≥–ª–∏—Ç–µ –¥–∞–Ω–Ω–∏—Ç–µ —Å–∏",
                openSheets: "–û—Ç–≤–æ—Ä–µ—Ç–µ Google Sheets –∏ —Å—ä–∑–¥–∞–π—Ç–µ –Ω–æ–≤–∞ —Ç–∞–±–ª–∏—Ü–∞",
                importStep: "–û—Ç–∏–¥–µ—Ç–µ –Ω–∞ File ‚Üí Import ‚Üí Upload ‚Üí –∏–∑–±–µ—Ä–µ—Ç–µ CSV —Ñ–∞–π–ª–∞",
                createCharts: "–î–∞–Ω–Ω–∏—Ç–µ –≤–∏ —â–µ –±—ä–¥–∞—Ç –∏–º–ø–æ—Ä—Ç–∏—Ä–∞–Ω–∏ –∏ –º–æ–∂–µ—Ç–µ –¥–∞ —Å—ä–∑–¥–∞–≤–∞—Ç–µ –≥—Ä–∞—Ñ–∏–∫–∏ —Ç–∞–º!",
                
                // BMI Categories
                underweight: "–ü–æ–¥–Ω–æ—Ä–º–µ–Ω–æ",
                normal: "–ù–æ—Ä–º–∞–ª–Ω–æ",
                overweight: "–ù–∞–¥–Ω–æ—Ä–º–µ–Ω–æ",
                obese: "–ó–∞—Ç–ª—ä—Å—Ç—è–≤–∞–Ω–µ",
                
                // Alerts
                enterValidHeight: "–ú–æ–ª—è, –≤—ä–≤–µ–¥–µ—Ç–µ –≤–∞–ª–∏–¥–Ω–∞ –≤–∏—Å–æ—á–∏–Ω–∞ –º–µ–∂–¥—É 100cm –∏ 250cm",
                enterDateWeight: "–ú–æ–ª—è, –≤—ä–≤–µ–¥–µ—Ç–µ –ø–æ–Ω–µ –¥–∞—Ç–∞ –∏ —Ç–µ–≥–ª–æ",
                setHeightFirstAlert: "–ú–æ–ª—è, –ø—ä—Ä–≤–æ –∑–∞–¥–∞–π—Ç–µ –≤–∏—Å–æ—á–∏–Ω–∞—Ç–∞ —Å–∏ –≤ —Å–µ–∫—Ü–∏—è—Ç–∞ –∑–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏",
                enterValidNumber: "–ú–æ–ª—è, –≤—ä–≤–µ–¥–µ—Ç–µ –≤–∞–ª–∏–¥–Ω–æ —á–∏—Å–ª–æ –∑–∞ {{field}}",
                enterValidGoalWeight: "–ú–æ–ª—è, –≤—ä–≤–µ–¥–µ—Ç–µ –≤–∞–ª–∏–¥–Ω–æ —Ü–µ–ª–µ–≤–æ —Ç–µ–≥–ª–æ",
                selectGoalDate: "–ú–æ–ª—è, –∏–∑–±–µ—Ä–µ—Ç–µ —Ü–µ–ª–µ–≤–∞ –¥–∞—Ç–∞",
                selectFutureDate: "–ú–æ–ª—è, –∏–∑–±–µ—Ä–µ—Ç–µ –±—ä–¥–µ—â–∞ –¥–∞—Ç–∞ –∑–∞ –≤–∞—à–∞—Ç–∞ —Ü–µ–ª",
                deleteConfirm: "–°–∏–≥—É—Ä–Ω–∏ –ª–∏ —Å—Ç–µ, —á–µ –∏—Å–∫–∞—Ç–µ –¥–∞ –∏–∑—Ç—Ä–∏–µ—Ç–µ —Ç–æ–≤–∞ –∏–∑–º–µ—Ä–≤–∞–Ω–µ?",
                deleteAllConfirm: "–°–∏–≥—É—Ä–Ω–∏ –ª–∏ —Å—Ç–µ, —á–µ –∏—Å–∫–∞—Ç–µ –¥–∞ –∏–∑—Ç—Ä–∏–µ—Ç–µ –í–°–ò–ß–ö–ò –∏–∑–º–µ—Ä–≤–∞–Ω–∏—è? –¢–æ–≤–∞ –Ω–µ –º–æ–∂–µ –¥–∞ –±—ä–¥–µ –æ—Ç–º–µ–Ω–µ–Ω–æ."
            }
        };

        const state = {
            measurements: [],
            showForm: false,
            showCharts: true,
            activeChart: 'weight',
            userHeight: localStorage.getItem('userHeight') || '',
            tempHeight: '',
            goalWeight: localStorage.getItem('goalWeight') || '',
            goalDate: localStorage.getItem('goalDate') || '',
            language: localStorage.getItem('language') || 'en',
            formData: {
                date: new Date().toISOString().split('T')[0],
                weight: '',
                chest: '',
                waist: '',
                hips: '',
                arms: '',
                thighs: '',
                notes: ''
            },
            charts: {}
        };

        // Translation function
        function t(key, variables = {}) {
            let text = translations[state.language][key] || translations.en[key] || key;
            
            // Replace variables like {{variable}}
            Object.keys(variables).forEach(variable => {
                text = text.replace(`{{${variable}}}`, variables[variable]);
            });
            
            return text;
        }

        function loadData() {
            const saved = localStorage.getItem('ketoMeasurements');
            if (saved) {
                state.measurements = JSON.parse(saved);
            }
        }

        function saveData() {
            localStorage.setItem('ketoMeasurements', JSON.stringify(state.measurements));
        }

        function saveHeight() {
            localStorage.setItem('userHeight', state.userHeight);
        }

        function saveGoal() {
            localStorage.setItem('goalWeight', state.goalWeight);
            localStorage.setItem('goalDate', state.goalDate);
        }

        function saveLanguage() {
            localStorage.setItem('language', state.language);
        }

        function toggleLanguage() {
            state.language = state.language === 'en' ? 'bg' : 'en';
            saveLanguage();
            render();
            destroyCharts();
            if (state.showCharts && state.measurements.length >= 0) {
                setTimeout(createCharts, 100);
            }
        }

        function resetForm() {
            state.formData = {
                date: new Date().toISOString().split('T')[0],
                weight: '',
                chest: '',
                waist: '',
                hips: '',
                arms: '',
                thighs: '',
                notes: ''
            };
        }

        function calculateBMI(weight, height) {
            if (!weight || !height) return null;
            const heightInMeters = height / 100;
            return (weight / (heightInMeters * heightInMeters)).toFixed(1);
        }

        function getBMICategory(bmi) {
            if (!bmi) return '';
            if (bmi < 18.5) return t('underweight');
            if (bmi < 25) return t('normal');
            if (bmi < 30) return t('overweight');
            return t('obese');
        }

        function getBMIColor(bmi) {
            if (!bmi) return 'bmi-normal';
            if (bmi < 18.5) return 'bmi-underweight';
            if (bmi < 25) return 'bmi-normal';
            if (bmi < 30) return 'bmi-overweight';
            return 'bmi-obese';
        }

        function calculateGoalBMI() {
            if (!state.goalWeight || !state.userHeight) return null;
            return calculateBMI(state.goalWeight, state.userHeight);
        }

        function calculatePrognosis() {
            if (!state.goalWeight || !state.goalDate) return null;
            
            const currentWeight = state.measurements.length > 0 ? 
                parseFloat(state.measurements[state.measurements.length - 1].weight) : 
                (state.userHeight ? 80 : null); // Default current weight if no measurements
            
            if (!currentWeight) return null;
            
            const goalWeight = parseFloat(state.goalWeight);
            const currentDate = new Date();
            const goalDate = new Date(state.goalDate);
            
            if (goalDate <= currentDate) return null;
            
            const daysRemaining = (goalDate - currentDate) / (1000 * 60 * 60 * 24);
            const weightToLose = currentWeight - goalWeight;
            
            // If we have multiple measurements, calculate trend, otherwise use safe default
            let weeklyLossRate;
            if (state.measurements.length >= 2) {
                const firstWeight = parseFloat(state.measurements[0].weight);
                const lastWeight = parseFloat(state.measurements[state.measurements.length - 1].weight);
                const daysBetween = (new Date(state.measurements[state.measurements.length - 1].date) - new Date(state.measurements[0].date)) / (1000 * 60 * 60 * 24);
                const totalLoss = firstWeight - lastWeight;
                weeklyLossRate = daysBetween > 0 ? (totalLoss / daysBetween) * 7 : 0.5;
            } else {
                // Safe default: 0.5 kg per week
                weeklyLossRate = 0.5;
            }
            
            const dailyLossNeeded = weightToLose / daysRemaining;
            const weeklyLossNeeded = dailyLossNeeded * 7;
            
            return {
                currentWeight,
                goalWeight,
                currentDate,
                goalDate,
                daysRemaining: Math.ceil(daysRemaining),
                weightToLose: weightToLose.toFixed(1),
                weeklyLossNeeded: weeklyLossNeeded.toFixed(2),
                dailyLossNeeded: dailyLossNeeded.toFixed(3),
                currentWeeklyRate: weeklyLossRate.toFixed(2),
                isAchievable: weeklyLossNeeded <= 1.0
            };
        }

        function generatePrognosisData() {
            const prognosis = calculatePrognosis();
            if (!prognosis) return null;
            
            const data = [];
            const currentDate = new Date();
            const goalDate = new Date(state.goalDate);
            const currentWeight = prognosis.currentWeight;
            const goalWeight = parseFloat(state.goalWeight);
            
            // Add current point
            data.push({
                x: currentDate,
                y: currentWeight
            });
            
            // Add weekly prognosis points
            const weeks = Math.ceil(prognosis.daysRemaining / 7);
            for (let i = 1; i <= weeks; i++) {
                const date = new Date(currentDate);
                date.setDate(date.getDate() + (i * 7));
                
                if (date > goalDate) break;
                
                const weight = currentWeight - (prognosis.weeklyLossNeeded * i);
                data.push({
                    x: date,
                    y: Math.max(weight, goalWeight)
                });
            }
            
            // Ensure goal point is included
            data.push({
                x: goalDate,
                y: goalWeight
            });
            
            return data;
        }

        function addMeasurement() {
            if (!state.formData.weight || !state.formData.date) {
                alert(t('enterDateWeight'));
                return;
            }
            
            if (!state.userHeight) {
                alert(t('setHeightFirstAlert'));
                return;
            }
            
            // Validate numeric fields
            const numericFields = ['weight', 'chest', 'waist', 'hips', 'arms', 'thighs'];
            for (const field of numericFields) {
                if (state.formData[field] && isNaN(state.formData[field])) {
                    alert(t('enterValidNumber', { field }));
                    return;
                }
            }
            
            const bmi = calculateBMI(state.formData.weight, state.userHeight);
            
            const newMeasurement = {
                id: Date.now(),
                ...state.formData,
                bmi: bmi,
                bmiCategory: getBMICategory(bmi),
                week: state.measurements.length + 1
            };
            
            state.measurements.push(newMeasurement);
            saveData();
            resetForm();
            state.showForm = false;
            render();
            destroyCharts();
        }

        function deleteMeasurement(id) {
            if (confirm(t('deleteConfirm'))) {
                state.measurements = state.measurements.filter(m => m.id !== id);
                state.measurements.forEach((m, index) => {
                    m.week = index + 1;
                });
                saveData();
                render();
                destroyCharts();
            }
        }

        function destroyCharts() {
            Object.values(state.charts).forEach(chart => {
                if (chart) chart.destroy();
            });
            state.charts = {};
        }

        function createCharts() {
            // Calculate date range (6 months from first measurement or today)
            const firstDate = state.measurements.length > 0 ? 
                new Date(state.measurements[0].date) : new Date();
            const endDate = new Date(firstDate);
            endDate.setMonth(endDate.getMonth() + 6);
            
            // Weight Chart - Always create if we have at least goal or measurements
            const weightCtx = document.getElementById('weightChart');
            if (weightCtx && (state.measurements.length > 0 || state.goalWeight)) {
                const datasets = [];

                // Add actual measurements if available
                if (state.measurements.length > 0) {
                    const measurementData = state.measurements.map(m => ({
                        x: new Date(m.date),
                        y: parseFloat(m.weight)
                    }));

                    datasets.push({
                        label: t('weight'),
                        data: measurementData,
                        borderColor: '#10B981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    });
                }

                // Add prognosis line if goal is set
                const prognosisData = generatePrognosisData();
                if (prognosisData) {
                    datasets.push({
                        label: t('prognosisAnalysis'),
                        data: prognosisData,
                        borderColor: '#8B5CF6',
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        fill: false,
                        tension: 0,
                        pointRadius: 0,
                        pointHoverRadius: 0
                    });
                    
                    // Add goal point
                    datasets.push({
                        label: t('weightGoal'),
                        data: [{
                            x: new Date(state.goalDate),
                            y: parseFloat(state.goalWeight)
                        }],
                        borderColor: '#8B5CF6',
                        backgroundColor: '#8B5CF6',
                        borderWidth: 2,
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        pointStyle: 'star'
                    });
                }

                state.charts.weight = new Chart(weightCtx, {
                    type: 'line',
                    data: {
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    title: function(context) {
                                        return new Date(context[0].parsed.x).toLocaleDateString();
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                grid: {
                                    color: 'rgba(0,0,0,0.1)'
                                },
                                title: {
                                    display: true,
                                    text: t('weight') + ' (kg)'
                                }
                            },
                            x: {
                                type: 'time',
                                time: {
                                    unit: 'month',
                                    displayFormats: {
                                        month: 'MMM yyyy'
                                    }
                                },
                                min: firstDate,
                                max: endDate,
                                grid: {
                                    display: false
                                },
                                title: {
                                    display: true,
                                    text: t('date')
                                }
                            }
                        }
                    }
                });
            }
            
            // BMI Chart
            const bmiCtx = document.getElementById('bmiChart');
            if (bmiCtx && state.userHeight && state.measurements.length > 0) {
                const bmiData = state.measurements.map(m => ({
                    x: new Date(m.date),
                    y: parseFloat(m.bmi)
                }));

                const goalBMI = calculateGoalBMI();
                const datasets = [
                    {
                        label: 'BMI',
                        data: bmiData,
                        borderColor: '#3B82F6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }
                ];

                if (goalBMI && state.goalDate) {
                    datasets.push({
                        label: t('goalBMI'),
                        data: [
                            { x: new Date(), y: goalBMI },
                            { x: new Date(state.goalDate), y: goalBMI }
                        ],
                        borderColor: '#8B5CF6',
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        fill: false,
                        tension: 0,
                        pointRadius: 0
                    });
                }

                state.charts.bmi = new Chart(bmiCtx, {
                    type: 'line',
                    data: {
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                grid: {
                                    color: 'rgba(0,0,0,0.1)'
                                },
                                title: {
                                    display: true,
                                    text: 'BMI'
                                }
                            },
                            x: {
                                type: 'time',
                                time: {
                                    unit: 'month',
                                    displayFormats: {
                                        month: 'MMM yyyy'
                                    }
                                },
                                min: firstDate,
                                max: endDate,
                                grid: {
                                    display: false
                                },
                                title: {
                                    display: true,
                                    text: t('date')
                                }
                            }
                        }
                    }
                });
            }
            
            // Measurements Chart
            const measurementsCtx = document.getElementById('measurementsChart');
            if (measurementsCtx && state.measurements.some(m => m.chest || m.waist || m.hips)) {
                const datasets = [];
                
                if (state.measurements.some(m => m.chest)) {
                    datasets.push({
                        label: t('chest'),
                        data: state.measurements.map(m => ({
                            x: new Date(m.date),
                            y: m.chest ? parseFloat(m.chest) : null
                        })),
                        borderColor: '#8B5CF6',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.4
                    });
                }
                
                if (state.measurements.some(m => m.waist)) {
                    datasets.push({
                        label: t('waist'),
                        data: state.measurements.map(m => ({
                            x: new Date(m.date),
                            y: m.waist ? parseFloat(m.waist) : null
                        })),
                        borderColor: '#EF4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.4
                    });
                }
                
                if (state.measurements.some(m => m.hips)) {
                    datasets.push({
                        label: t('hips'),
                        data: state.measurements.map(m => ({
                            x: new Date(m.date),
                            y: m.hips ? parseFloat(m.hips) : null
                        })),
                        borderColor: '#F59E0B',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.4
                    });
                }
                
                state.charts.measurements = new Chart(measurementsCtx, {
                    type: 'line',
                    data: {
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                grid: {
                                    color: 'rgba(0,0,0,0.1)'
                                },
                                title: {
                                    display: true,
                                    text: t('measurements') + ' (cm)'
                                }
                            },
                            x: {
                                type: 'time',
                                time: {
                                    unit: 'month',
                                    displayFormats: {
                                        month: 'MMM yyyy'
                                    }
                                },
                                min: firstDate,
                                max: endDate,
                                grid: {
                                    display: false
                                },
                                title: {
                                    display: true,
                                    text: t('date')
                                }
                            }
                        }
                    }
                });
            }
        }

        function exportToCSV() {
            if (state.measurements.length === 0) return;
            
            const headers = ['Week', 'Date', 'Weight (kg)', 'BMI', 'BMI Category', 'Chest (cm)', 'Waist (cm)', 'Hips (cm)', 'Arms (cm)', 'Thighs (cm)', 'Notes'];
            const rows = state.measurements.map(m => [
                m.week,
                m.date,
                m.weight,
                m.bmi || '',
                m.bmiCategory || '',
                m.chest || '',
                m.waist || '',
                m.hips || '',
                m.arms || '',
                m.thighs || '',
                `"${(m.notes || '').replace(/"/g, '""')}"`
            ]);
            
            const csv = [headers, ...rows].map(row => row.join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `keto-progress-${new Date().toISOString().split('T')[0]}.csv`;
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function importFromCSV(e) {
            const file = e.target.files?.[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const text = event.target.result;
                    const lines = text.split('\n').slice(1);
                    const imported = lines
                        .filter(line => line.trim())
                        .map((line, index) => {
                            const values = line.match(/(".*?"|[^,]+)(?=\s*,|\s*$)/g) || [];
                            const cleanValues = values.map(v => v.replace(/^"|"$/g, '').replace(/""/g, '"'));
                            
                            return {
                                id: Date.now() + index,
                                week: parseInt(cleanValues[0]) || index + 1,
                                date: cleanValues[1] || '',
                                weight: cleanValues[2] || '',
                                bmi: cleanValues[3] || '',
                                bmiCategory: cleanValues[4] || '',
                                chest: cleanValues[5] || '',
                                waist: cleanValues[6] || '',
                                hips: cleanValues[7] || '',
                                arms: cleanValues[8] || '',
                                thighs: cleanValues[9] || '',
                                notes: cleanValues[10] || ''
                            };
                        });
                    
                    if (imported.length > 0) {
                        state.measurements = imported;
                        saveData();
                        alert(`Successfully imported ${imported.length} measurements!`);
                        render();
                        destroyCharts();
                    }
                } catch (error) {
                    alert('Error importing CSV. Please check the file format.');
                }
            };
            reader.readAsText(file);
            e.target.value = '';
        }

        function updateFormField(field, value) {
            state.formData[field] = value;
        }

        function updateTempHeight(value) {
            state.tempHeight = value;
        }

        function saveHeightInput() {
            if (!state.tempHeight || isNaN(state.tempHeight)) {
                alert(t('enterValidHeight'));
                return;
            }
            
            const heightValue = parseFloat(state.tempHeight);
            if (heightValue < 100 || heightValue > 250) {
                alert(t('enterValidHeight'));
                return;
            }
            
            state.userHeight = state.tempHeight;
            saveHeight();
            render();
            
            const heightInput = document.getElementById('heightInput');
            if (heightInput) {
                heightInput.value = '';
            }
        }

        function handleHeightKeyPress(e) {
            if (e.key === 'Enter') {
                saveHeightInput();
            }
        }

        function updateGoalWeight(value) {
            state.goalWeight = value;
        }

        function updateGoalDate(value) {
            state.goalDate = value;
        }

        function saveGoalInput() {
            if (!state.goalWeight || isNaN(state.goalWeight)) {
                alert(t('enterValidGoalWeight'));
                return;
            }
            
            if (!state.goalDate) {
                alert(t('selectGoalDate'));
                return;
            }
            
            const goalDate = new Date(state.goalDate);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            if (goalDate <= today) {
                alert(t('selectFutureDate'));
                return;
            }
            
            saveGoal();
            render();
            destroyCharts();
            
            setTimeout(() => {
                if (state.showCharts) {
                    createCharts();
                }
            }, 100);
        }

        function getTotalWeightLoss() {
            if (state.measurements.length < 2) return 0;
            const first = parseFloat(state.measurements[0].weight);
            const last = parseFloat(state.measurements[state.measurements.length - 1].weight);
            return (first - last).toFixed(1);
        }

        function getCurrentWeight() {
            if (state.measurements.length === 0) return '--';
            return state.measurements[state.measurements.length - 1].weight;
        }

        function getCurrentBMI() {
            if (state.measurements.length === 0 || !state.userHeight) return '--';
            const currentWeight = parseFloat(getCurrentWeight());
            return calculateBMI(currentWeight, state.userHeight);
        }

        function getWaistToHeightRatio() {
            if (state.measurements.length === 0 || !state.userHeight) return '--';
            const last = state.measurements[state.measurements.length - 1];
            if (!last.waist) return '--';
            return (last.waist / state.userHeight).toFixed(2);
        }

        function getWaistToHipRatio() {
            if (state.measurements.length === 0) return '--';
            const last = state.measurements[state.measurements.length - 1];
            if (!last.waist || !last.hips) return '--';
            return (last.waist / last.hips).toFixed(2);
        }

        function toggleCharts() {
            state.showCharts = !state.showCharts;
            render();
            if (state.showCharts) {
                setTimeout(createCharts, 100);
            }
        }

        function setActiveChart(chartType) {
            state.activeChart = chartType;
            render();
            if (state.showCharts) {
                setTimeout(createCharts, 100);
            }
        }

        function render() {
            const app = document.getElementById('app');
            const totalLoss = getTotalWeightLoss();
            const currentWeight = getCurrentWeight();
            const currentBMI = getCurrentBMI();
            const bmiCategory = getBMICategory(currentBMI);
            const bmiColor = getBMIColor(currentBMI);
            const waistToHeight = getWaistToHeightRatio();
            const waistToHip = getWaistToHipRatio();
            const prognosis = calculatePrognosis();
            const goalBMI = calculateGoalBMI();
            
            app.innerHTML = `
                <!-- Language Switcher -->
                <div class="flex justify-end mb-4">
                    <button onclick="toggleLanguage()" class="lang-switcher px-4 py-2 rounded-full border-2 border-emerald-500 text-emerald-600 font-semibold hover:bg-emerald-500 hover:text-white transition">
                        ${state.language === 'en' ? '–ë—ä–ª–≥–∞—Ä—Å–∫–∏' : 'English'}
                    </button>
                </div>

                <!-- Header -->
                <div class="bg-white rounded-2xl shadow-lg p-4 sm:p-6 mb-4 sm:mb-6 fade-in">
                    <div class="flex items-center justify-between mb-4 flex-wrap gap-3 mobile-stack">
                        <div class="flex items-center gap-3">
                            <svg class="w-6 h-6 sm:w-8 sm:h-8 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3"></path>
                            </svg>
                            <h1 class="text-xl sm:text-3xl font-bold text-gray-800 mobile-text-lg">${t('title')}</h1>
                        </div>
                        <div class="flex gap-2 w-full sm:w-auto justify-between">
                            <label class="cursor-pointer bg-blue-500 text-white px-3 py-2 sm:px-4 sm:py-2 rounded-lg hover:bg-blue-600 transition flex items-center gap-2 text-sm sm:text-base flex-1 sm:flex-none justify-center">
                                <svg class="w-3 h-3 sm:w-4 sm:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                                </svg>
                                ${t('import')}
                                <input type="file" accept=".csv" onchange="importFromCSV(event)" class="hidden">
                            </label>
                            <button onclick="exportToCSV()" class="bg-emerald-500 text-white px-3 py-2 sm:px-4 sm:py-2 rounded-lg hover:bg-emerald-600 transition flex items-center gap-2 text-sm sm:text-base flex-1 sm:flex-none justify-center ${state.measurements.length === 0 ? 'opacity-50 cursor-not-allowed' : ''}" ${state.measurements.length === 0 ? 'disabled' : ''}>
                                <svg class="w-3 h-3 sm:w-4 sm:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                </svg>
                                ${t('export')}
                            </button>
                        </div>
                    </div>

                    <!-- Height Settings -->
                    <div class="bg-gray-50 rounded-xl p-3 sm:p-4 mb-4 sm:mb-6">
                        <h3 class="font-bold text-gray-800 mb-2 sm:mb-3 flex items-center gap-2 text-sm sm:text-base">
                            <svg class="w-4 h-4 sm:w-5 sm:h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                            </svg>
                            ${t('profile')}
                        </h3>
                        <div class="space-y-3">
                            ${state.userHeight ? `
                                <div class="flex items-center justify-between p-2 bg-green-50 rounded-lg border border-green-200">
                                    <div>
                                        <div class="text-sm font-semibold text-green-800">${t('currentHeight')}</div>
                                        <div class="text-lg font-bold text-green-900">${state.userHeight} cm</div>
                                    </div>
                                    <button onclick="state.userHeight = ''; saveHeight(); render();" class="text-red-500 hover:text-red-700 text-sm font-medium">
                                        ${t('change')}
                                    </button>
                                </div>
                            ` : `
                                <div class="height-input-container">
                                    <div class="height-input">
                                        <label class="block text-sm font-semibold mb-1 sm:mb-2 text-gray-700">${t('height')} (cm) *</label>
                                        <input 
                                            type="number" 
                                            id="heightInput"
                                            oninput="updateTempHeight(this.value)"
                                            onkeypress="handleHeightKeyPress(event)"
                                            class="w-full px-3 py-2 sm:px-4 sm:py-2 border-2 border-gray-300 rounded-lg focus:border-emerald-500 focus:outline-none text-sm sm:text-base" 
                                            placeholder="${t('heightPlaceholder')}"
                                            min="100"
                                            max="250"
                                            step="0.1"
                                        >
                                    </div>
                                    <button 
                                        onclick="saveHeightInput()" 
                                        class="height-button bg-emerald-500 text-white px-4 py-2 rounded-lg hover:bg-emerald-600 transition font-semibold h-fit"
                                    >
                                        ${t('setHeight')}
                                    </button>
                                </div>
                                <div class="text-xs text-gray-600">
                                    <div>${t('heightRequired')}</div>
                                </div>
                            `}
                        </div>
                    </div>

                    <!-- Goal Settings -->
                    <div class="bg-purple-50 rounded-xl p-3 sm:p-4 mb-4 sm:mb-6 goal-section">
                        <h3 class="font-bold text-purple-800 mb-2 sm:mb-3 flex items-center gap-2 text-sm sm:text-base">
                            <svg class="w-4 h-4 sm:w-5 sm:h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            ${t('weightGoal')}
                        </h3>
                        <div class="space-y-3">
                            ${state.goalWeight && state.goalDate ? `
                                <div class="flex items-center justify-between p-2 bg-white rounded-lg border border-purple-200">
                                    <div>
                                        <div class="text-sm font-semibold text-purple-800">${t('currentGoal')}</div>
                                        <div class="text-lg font-bold text-purple-900">${state.goalWeight} kg ${t('by')} ${new Date(state.goalDate).toLocaleDateString()}</div>
                                        ${goalBMI ? `<div class="text-sm text-purple-700">${t('goalBMI')}: ${goalBMI} (${getBMICategory(goalBMI)})</div>` : ''}
                                        ${prognosis ? `
                                            <div class="text-xs text-purple-600 mt-1">
                                                ${t('needToLose')} ${prognosis.weightToLose}kg ${t('in')} ${prognosis.daysRemaining} ${t('days')}
                                                (${prognosis.weeklyLossNeeded}kg/${t('week')})
                                                ${prognosis.isAchievable ? 'üéØ' : '‚ö†Ô∏è'}
                                            </div>
                                        ` : ''}
                                    </div>
                                    <button onclick="state.goalWeight = ''; state.goalDate = ''; saveGoal(); render(); destroyCharts();" class="text-red-500 hover:text-red-700 text-sm font-medium">
                                        ${t('change')}
                                    </button>
                                </div>
                            ` : `
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-sm font-semibold mb-1 sm:mb-2 text-gray-700">${t('goalWeight')} (kg)</label>
                                        <input 
                                            type="number" 
                                            step="0.1"
                                            value="${state.goalWeight}"
                                            oninput="updateGoalWeight(this.value)"
                                            class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none text-sm sm:text-base" 
                                            placeholder="e.g., 65.0"
                                        >
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold mb-1 sm:mb-2 text-gray-700">${t('targetDate')}</label>
                                        <input 
                                            type="date" 
                                            value="${state.goalDate}"
                                            oninput="updateGoalDate(this.value)"
                                            class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none text-sm sm:text-base" 
                                            min="${new Date().toISOString().split('T')[0]}"
                                        >
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    <button 
                                        onclick="saveGoalInput()" 
                                        class="bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600 transition font-semibold"
                                    >
                                        ${t('setGoal')}
                                    </button>
                                    ${state.userHeight && state.goalWeight ? `
                                        <div class="text-xs text-purple-700 p-2">
                                            ${t('goalBMI')}: ${calculateGoalBMI()} (${getBMICategory(calculateGoalBMI())})
                                        </div>
                                    ` : ''}
                                </div>
                                <div class="text-xs text-gray-600">
                                    <div>${t('goalDescription')}</div>
                                </div>
                            `}
                        </div>
                    </div>

                    <!-- Stats -->
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-2 sm:gap-4">
                        <div class="bg-gradient-to-br from-emerald-500 to-teal-600 text-white p-3 sm:p-4 rounded-xl">
                            <div class="text-xs sm:text-sm opacity-90 mb-1">${t('currentWeight')}</div>
                            <div class="text-xl sm:text-3xl font-bold">${currentWeight} kg</div>
                        </div>
                        <div class="bg-gradient-to-br from-blue-500 to-indigo-600 text-white p-3 sm:p-4 rounded-xl">
                            <div class="text-xs sm:text-sm opacity-90 mb-1">${t('totalLoss')}</div>
                            <div class="text-xl sm:text-3xl font-bold">${totalLoss} kg</div>
                        </div>
                        <div class="${bmiColor} text-white p-3 sm:p-4 rounded-xl">
                            <div class="text-xs sm:text-sm opacity-90 mb-1">BMI ${bmiCategory ? `(${bmiCategory})` : ''}</div>
                            <div class="text-xl sm:text-3xl font-bold">${currentBMI}</div>
                        </div>
                        <div class="bg-gradient-to-br from-purple-500 to-pink-600 text-white p-3 sm:p-4 rounded-xl">
                            <div class="text-xs sm:text-sm opacity-90 mb-1">${t('weeks')}</div>
                            <div class="text-xl sm:text-3xl font-bold">${state.measurements.length}</div>
                        </div>
                    </div>

                    <!-- Additional Health Metrics -->
                    ${state.measurements.length > 0 ? `
                    <div class="grid grid-cols-2 gap-2 sm:gap-4 mt-3 sm:mt-4">
                        <div class="bg-white border-2 border-gray-200 p-2 sm:p-4 rounded-xl">
                            <div class="text-xs sm:text-sm text-gray-600 mb-1">${t('waistHeight')}</div>
                            <div class="text-lg sm:text-2xl font-bold text-gray-800">${waistToHeight}</div>
                            <div class="text-xs text-gray-500 mt-1">${t('healthy')}: &lt;0.5</div>
                        </div>
                        <div class="bg-white border-2 border-gray-200 p-2 sm:p-4 rounded-xl">
                            <div class="text-xs sm:text-sm text-gray-600 mb-1">${t('waistHip')}</div>
                            <div class="text-lg sm:text-2xl font-bold text-gray-800">${waistToHip}</div>
                            <div class="text-xs text-gray-500 mt-1">${t('male')}:&lt;0.9, ${t('female')}:&lt;0.85</div>
                        </div>
                    </div>
                    ` : ''}
                </div>

                <!-- Charts Section -->
                ${(state.measurements.length >= 0 || state.goalWeight) ? `
                <div class="bg-white rounded-2xl shadow-lg p-4 sm:p-6 mb-4 sm:mb-6 fade-in">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg sm:text-xl font-bold flex items-center gap-2">
                            <svg class="w-4 h-4 sm:w-5 sm:h-5 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                            ${t('progressCharts')}
                        </h2>
                        <button onclick="toggleCharts()" class="text-sm bg-gray-200 text-gray-700 px-3 py-1 rounded-lg hover:bg-gray-300 transition">
                            ${state.showCharts ? t('hideCharts') : t('showCharts')}
                        </button>
                    </div>
                    
                    ${state.showCharts ? `
                    <div class="mb-4">
                        <div class="flex gap-2 overflow-x-auto pb-2 mobile-scroll">
                            <button onclick="setActiveChart('weight')" class="whitespace-nowrap px-3 py-2 rounded-lg transition ${state.activeChart === 'weight' ? 'bg-emerald-500 text-white' : 'bg-gray-200 text-gray-700'}">
                                ${t('weight')}
                            </button>
                            ${state.userHeight && state.measurements.length > 0 ? `
                            <button onclick="setActiveChart('bmi')" class="whitespace-nowrap px-3 py-2 rounded-lg transition ${state.activeChart === 'bmi' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700'}">
                                BMI
                            </button>
                            ` : ''}
                            ${state.measurements.some(m => m.chest || m.waist || m.hips) ? `
                            <button onclick="setActiveChart('measurements')" class="whitespace-nowrap px-3 py-2 rounded-lg transition ${state.activeChart === 'measurements' ? 'bg-purple-500 text-white' : 'bg-gray-200 text-gray-700'}">
                                ${t('measurements')}
                            </button>
                            ` : ''}
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        ${state.activeChart === 'weight' ? '<canvas id="weightChart"></canvas>' : ''}
                        ${state.activeChart === 'bmi' ? '<canvas id="bmiChart"></canvas>' : ''}
                        ${state.activeChart === 'measurements' ? '<canvas id="measurementsChart"></canvas>' : ''}
                    </div>

                    ${prognosis ? `
                    <div class="mt-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                        <h4 class="font-semibold text-blue-800 mb-2">${t('prognosisAnalysis')}</h4>
                        <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 text-sm">
                            <div>
                                <div class="text-blue-600">${t('daysRemaining')}</div>
                                <div class="font-bold">${prognosis.daysRemaining}</div>
                            </div>
                            <div>
                                <div class="text-blue-600">${t('weightToLose')}</div>
                                <div class="font-bold">${prognosis.weightToLose} kg</div>
                            </div>
                            <div>
                                <div class="text-blue-600">${t('weeklyLossNeeded')}</div>
                                <div class="font-bold">${prognosis.weeklyLossNeeded} kg/${t('week')}</div>
                            </div>
                            <div>
                                <div class="text-blue-600">${t('status')}</div>
                                <div class="font-bold">${prognosis.isAchievable ? t('achievable') : t('challenging')}</div>
                            </div>
                        </div>
                        ${state.measurements.length >= 2 ? `
                        <div class="mt-2 text-xs text-blue-600">
                            ${t('currentRate')}: ${prognosis.currentWeeklyRate} kg/${t('week')}
                        </div>
                        ` : ''}
                    </div>
                    ` : ''}
                    ` : ''}
                </div>
                ` : ''}

                <!-- Add Button -->
                <button onclick="toggleForm()" class="w-full bg-emerald-600 text-white py-3 sm:py-4 rounded-xl hover:bg-emerald-700 transition mb-4 sm:mb-6 flex items-center justify-center gap-2 font-semibold shadow-lg fade-in ${!state.userHeight ? 'opacity-50 cursor-not-allowed' : ''}" ${!state.userHeight ? 'disabled' : ''}>
                    <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    ${state.showForm ? t('hideForm') : t('addMeasurement')}
                    ${!state.userHeight ? t('setHeightFirst') : ''}
                </button>

                <!-- Form -->
                ${state.showForm ? `
                <div class="bg-white rounded-2xl shadow-lg p-4 sm:p-6 mb-4 sm:mb-6 fade-in">
                    <h2 class="text-lg sm:text-xl font-bold mb-3 sm:mb-4 flex items-center gap-2">
                        <svg class="w-4 h-4 sm:w-5 sm:h-5 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        ${t('weekMeasurement', { week: state.measurements.length + 1 })}
                    </h2>
                    ${state.userHeight ? `
                        <div class="mb-3 sm:mb-4 p-2 sm:p-3 bg-blue-50 rounded-lg">
                            <div class="text-xs sm:text-sm text-blue-800">
                                <strong>${t('yourHeight')}:</strong> ${state.userHeight} cm
                                ${state.formData.weight ? `
                                <br><strong>${t('estimatedBMI')}:</strong> ${calculateBMI(state.formData.weight, state.userHeight)} (${getBMICategory(calculateBMI(state.formData.weight, state.userHeight))})
                                ` : ''}
                            </div>
                        </div>
                    ` : ''}
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 sm:gap-4">
                        <div>
                            <label class="block text-sm font-semibold mb-1 sm:mb-2 text-gray-700">${t('date')}</label>
                            <input type="date" id="date" value="${state.formData.date}" onchange="updateFormField('date', this.value)" class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:border-emerald-500 focus:outline-none text-sm sm:text-base">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-1 sm:mb-2 text-gray-700">${t('weightKg')}</label>
                            <input type="number" step="0.1" id="weight" value="${state.formData.weight}" oninput="updateFormField('weight', this.value)" class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:border-emerald-500 focus:outline-none text-sm sm:text-base" placeholder="e.g., 75.5">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-1 sm:mb-2 text-gray-700">${t('chest')}</label>
                            <input type="number" step="0.1" id="chest" value="${state.formData.chest}" oninput="updateFormField('chest', this.value)" class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:border-emerald-500 focus:outline-none text-sm sm:text-base" placeholder="e.g., 95.0">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-1 sm:mb-2 text-gray-700">${t('waist')}</label>
                            <input type="number" step="0.1" id="waist" value="${state.formData.waist}" oninput="updateFormField('waist', this.value)" class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:border-emerald-500 focus:outline-none text-sm sm:text-base" placeholder="e.g., 80.5">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-1 sm:mb-2 text-gray-700">${t('hips')}</label>
                            <input type="number" step="0.1" id="hips" value="${state.formData.hips}" oninput="updateFormField('hips', this.value)" class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:border-emerald-500 focus:outline-none text-sm sm:text-base" placeholder="e.g., 102.0">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-1 sm:mb-2 text-gray-700">${t('arms')}</label>
                            <input type="number" step="0.1" id="arms" value="${state.formData.arms}" oninput="updateFormField('arms', this.value)" class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:border-emerald-500 focus:outline-none text-sm sm:text-base" placeholder="e.g., 32.5">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-1 sm:mb-2 text-gray-700">${t('thighs')}</label>
                            <input type="number" step="0.1" id="thighs" value="${state.formData.thighs}" oninput="updateFormField('thighs', this.value)" class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:border-emerald-500 focus:outline-none text-sm sm:text-base" placeholder="e.g., 58.0">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-semibold mb-1 sm:mb-2 text-gray-700">${t('notes')}</label>
                            <textarea id="notes" rows="2" oninput="updateFormField('notes', this.value)" class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:border-emerald-500 focus:outline-none text-sm sm:text-base" placeholder="${t('notesPlaceholder')}">${state.formData.notes}</textarea>
                        </div>
                        <div class="md:col-span-2 flex gap-2 sm:gap-3">
                            <button onclick="addMeasurement()" class="flex-1 bg-emerald-600 text-white py-2 sm:py-3 rounded-lg hover:bg-emerald-700 transition font-semibold text-sm sm:text-base">
                                ${t('saveMeasurement')}
                            </button>
                            <button onclick="toggleForm()" class="px-4 sm:px-6 bg-gray-300 text-gray-700 py-2 sm:py-3 rounded-lg hover:bg-gray-400 transition font-semibold text-sm sm:text-base">
                                ${t('cancel')}
                            </button>
                        </div>
                    </div>
                </div>
                ` : ''}

                <!-- History -->
                <div class="bg-white rounded-2xl shadow-lg p-4 sm:p-6 fade-in">
                    <div class="flex justify-between items-center mb-3 sm:mb-4">
                        <h2 class="text-lg sm:text-xl font-bold flex items-center gap-2">
                            <svg class="w-4 h-4 sm:w-5 sm:h-5 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                            </svg>
                            ${t('progressHistory')}
                        </h2>
                        ${state.measurements.length > 0 ? `
                            <button onclick="clearAllData()" class="text-red-500 hover:text-red-700 text-xs sm:text-sm font-medium flex items-center gap-1">
                                <svg class="w-3 h-3 sm:w-4 sm:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                                ${t('clearAll')}
                            </button>
                        ` : ''}
                    </div>
                    ${state.measurements.length === 0 ? `
                        <div class="text-center py-8 sm:py-12 text-gray-500">
                            <svg class="w-12 h-12 sm:w-16 sm:h-16 mx-auto mb-3 sm:mb-4 opacity-30" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3"></path>
                            </svg>
                            <p class="text-base sm:text-lg">${t('noMeasurements')}</p>
                            ${!state.userHeight ? `<p class="text-xs sm:text-sm mt-1 sm:mt-2 text-amber-600">${t('dontForgetHeight')}</p>` : ''}
                        </div>
                    ` : `
                        <div class="overflow-x-auto mobile-scroll">
                            <table class="w-full min-w-[600px] sm:min-w-0">
                                <thead>
                                    <tr class="border-b-2 border-gray-200">
                                        <th class="text-left py-2 px-1 sm:py-3 sm:px-2 font-semibold text-gray-700 text-xs sm:text-sm">${t('week')}</th>
                                        <th class="text-left py-2 px-1 sm:py-3 sm:px-2 font-semibold text-gray-700 text-xs sm:text-sm">${t('date')}</th>
                                        <th class="text-left py-2 px-1 sm:py-3 sm:px-2 font-semibold text-gray-700 text-xs sm:text-sm">${t('weight')}</th>
                                        <th class="text-left py-2 px-1 sm:py-3 sm:px-2 font-semibold text-gray-700 text-xs sm:text-sm">BMI</th>
                                        <th class="text-left py-2 px-1 sm:py-3 sm:px-2 font-semibold text-gray-700 text-xs sm:text-sm">${t('chest')}</th>
                                        <th class="text-left py-2 px-1 sm:py-3 sm:px-2 font-semibold text-gray-700 text-xs sm:text-sm">${t('waist')}</th>
                                        <th class="text-left py-2 px-1 sm:py-3 sm:px-2 font-semibold text-gray-700 text-xs sm:text-sm">${t('hips')}</th>
                                        <th class="text-left py-2 px-1 sm:py-3 sm:px-2 font-semibold text-gray-700 text-xs sm:text-sm">${t('arms')}</th>
                                        <th class="text-left py-2 px-1 sm:py-3 sm:px-2 font-semibold text-gray-700 text-xs sm:text-sm">${t('thighs')}</th>
                                        <th class="text-left py-2 px-1 sm:py-3 sm:px-2 font-semibold text-gray-700 text-xs sm:text-sm">${t('notes')}</th>
                                        <th class="text-left py-2 px-1 sm:py-3 sm:px-2 font-semibold text-gray-700 text-xs sm:text-sm">${t('action')}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${state.measurements.map(m => `
                                        <tr class="border-b border-gray-100 hover:bg-gray-50">
                                            <td class="py-2 px-1 sm:py-3 sm:px-2 font-semibold text-emerald-600 text-xs sm:text-sm">W${m.week}</td>
                                            <td class="py-2 px-1 sm:py-3 sm:px-2 text-xs sm:text-sm">${m.date}</td>
                                            <td class="py-2 px-1 sm:py-3 sm:px-2 font-bold text-xs sm:text-sm">${m.weight} kg</td>
                                            <td class="py-2 px-1 sm:py-3 sm:px-2 text-xs sm:text-sm">
                                                <div class="flex flex-col">
                                                    <span class="font-semibold">${m.bmi || '-'}</span>
                                                    ${m.bmiCategory ? `<span class="text-xs text-gray-500">${m.bmiCategory}</span>` : ''}
                                                </div>
                                            </td>
                                            <td class="py-2 px-1 sm:py-3 sm:px-2 text-xs sm:text-sm">${m.chest || '-'} cm</td>
                                            <td class="py-2 px-1 sm:py-3 sm:px-2 text-xs sm:text-sm">${m.waist || '-'} cm</td>
                                            <td class="py-2 px-1 sm:py-3 sm:px-2 text-xs sm:text-sm">${m.hips || '-'} cm</td>
                                            <td class="py-2 px-1 sm:py-3 sm:px-2 text-xs sm:text-sm">${m.arms || '-'} cm</td>
                                            <td class="py-2 px-1 sm:py-3 sm:px-2 text-xs sm:text-sm">${m.thighs || '-'} cm</td>
                                            <td class="py-2 px-1 sm:py-3 sm:px-2 text-xs sm:text-sm text-gray-600 max-w-[80px] sm:max-w-xs truncate" title="${m.notes || ''}">${m.notes || '-'}</td>
                                            <td class="py-2 px-1 sm:py-3 sm:px-2">
                                                <button onclick="deleteMeasurement(${m.id})" class="text-red-500 hover:text-red-700 transition" title="${t('delete')}">
                                                    <svg class="w-3 h-3 sm:w-4 sm:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                                    </svg>
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `}
                </div>

                <!-- Instructions -->
                ${state.measurements.length > 0 ? `
                <div class="bg-blue-50 border-2 border-blue-200 rounded-xl p-3 sm:p-4 mt-4 sm:mt-6 fade-in">
                    <h3 class="font-bold text-blue-900 mb-1 sm:mb-2 text-sm sm:text-base">üìä ${t('googleSheets')}</h3>
                    <ol class="text-xs sm:text-sm text-blue-800 space-y-1 ml-3 sm:ml-4 list-decimal">
                        <li>${t('exportStep')}</li>
                        <li>${t('openSheets')}</li>
                        <li>${t('importStep')}</li>
                        <li>${t('createCharts')}</li>
                    </ol>
                </div>
                ` : ''}
            `;
            
            // Create charts after DOM is rendered
            if (state.showCharts) {
                setTimeout(createCharts, 100);
            }
        }

        function toggleForm() {
            if (!state.userHeight) {
                alert(t('setHeightFirstAlert'));
                return;
            }
            state.showForm = !state.showForm;
            render();
        }

        function clearAllData() {
            if (confirm(t('deleteAllConfirm'))) {
                state.measurements = [];
                saveData();
                render();
                destroyCharts();
            }
        }

        // Initialize
        loadData();
        render();
    </script>
</body>
</html>